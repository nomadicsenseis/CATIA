VAR __DS0FilterTable7 =
    TREATAS({"vs Sel. Period"}, 'Filtro_Comparativa'[Filtro_Comparativa])

VAR __DS0FilterTableSelPeriod =
    FILTER(
        KEEPFILTERS(VALUES('Aux_Date_Master_Selected_Period'[Date_aux])),
        AND(
            'Aux_Date_Master_Selected_Period'[Date_aux] >= DATE(__START_YEAR__, __START_MONTH__, __START_DAY__),
            'Aux_Date_Master_Selected_Period'[Date_aux] < DATE(__END_YEAR__, __END_MONTH__, __END_DAY__)
        ))

EVALUATE
ADDCOLUMNS(
    SUMMARIZE(
        FILTER(
            'Routes_Data',
            'Routes_Data'[Date] >= DATE(__CURRENT_START_YEAR__, __CURRENT_START_MONTH__, __CURRENT_START_DAY__) &&
            'Routes_Data'[Date] <= DATE(__CURRENT_END_YEAR__, __CURRENT_END_MONTH__, __CURRENT_END_DAY__) &&
            NOT(ISBLANK('Routes_Data'[Route])) &&
            NOT(ISBLANK('Routes_Data'[NPS_Score]))
        ),
        'Routes_Data'[Route],
        'Routes_Data'[Origin],
        'Routes_Data'[Destination],
        'Routes_Data'[Segment_Level_1],
        'Routes_Data'[Segment_Level_2],
        'Routes_Data'[Segment_Level_3]
    ),
    "NPS", CALCULATE(
        AVERAGE('Routes_Data'[NPS_Score])
    ),
    "NPS_SelPeriod", CALCULATE(
        AVERAGE('Routes_Data'[NPS_Score]),
        __DS0FilterTable7,
        __DS0FilterTableSelPeriod
    ),
    "NPS_Diff", [NPS] - [NPS_SelPeriod],
    "Surveys_Count", CALCULATE(
        COUNT('Routes_Data'[Survey_ID])
    ),
    "Surveys_Count_SelPeriod", CALCULATE(
        COUNT('Routes_Data'[Survey_ID]),
        __DS0FilterTable7,
        __DS0FilterTableSelPeriod
    ),
    "CSAT_Punctuality", CALCULATE(
        AVERAGE('Routes_Data'[CSAT_Punctuality])
    ),
    "CSAT_Punctuality_SelPeriod", CALCULATE(
        AVERAGE('Routes_Data'[CSAT_Punctuality]),
        __DS0FilterTable7,
        __DS0FilterTableSelPeriod
    ),
    "CSAT_Punctuality_Diff", [CSAT_Punctuality] - [CSAT_Punctuality_SelPeriod],
    "CSAT_Service", CALCULATE(
        AVERAGE('Routes_Data'[CSAT_Service])
    ),
    "CSAT_Service_SelPeriod", CALCULATE(
        AVERAGE('Routes_Data'[CSAT_Service]),
        __DS0FilterTable7,
        __DS0FilterTableSelPeriod
    ),
    "CSAT_Service_Diff", [CSAT_Service] - [CSAT_Service_SelPeriod],
    "CSAT_Baggage", CALCULATE(
        AVERAGE('Routes_Data'[CSAT_Baggage])
    ),
    "CSAT_Baggage_SelPeriod", CALCULATE(
        AVERAGE('Routes_Data'[CSAT_Baggage]),
        __DS0FilterTable7,
        __DS0FilterTableSelPeriod
    ),
    "CSAT_Baggage_Diff", [CSAT_Baggage] - [CSAT_Baggage_SelPeriod],
    "CSAT_Checkin", CALCULATE(
        AVERAGE('Routes_Data'[CSAT_Checkin])
    ),
    "CSAT_Checkin_SelPeriod", CALCULATE(
        AVERAGE('Routes_Data'[CSAT_Checkin]),
        __DS0FilterTable7,
        __DS0FilterTableSelPeriod
    ),
    "CSAT_Checkin_Diff", [CSAT_Checkin] - [CSAT_Checkin_SelPeriod],
    "CSAT_Boarding", CALCULATE(
        AVERAGE('Routes_Data'[CSAT_Boarding])
    ),
    "CSAT_Boarding_SelPeriod", CALCULATE(
        AVERAGE('Routes_Data'[CSAT_Boarding]),
        __DS0FilterTable7,
        __DS0FilterTableSelPeriod
    ),
    "CSAT_Boarding_Diff", [CSAT_Boarding] - [CSAT_Boarding_SelPeriod],
    "CSAT_Aircraft", CALCULATE(
        AVERAGE('Routes_Data'[CSAT_Aircraft])
    ),
    "CSAT_Aircraft_SelPeriod", CALCULATE(
        AVERAGE('Routes_Data'[CSAT_Aircraft]),
        __DS0FilterTable7,
        __DS0FilterTableSelPeriod
    ),
    "CSAT_Aircraft_Diff", [CSAT_Aircraft] - [CSAT_Aircraft_SelPeriod],
    "Load_Factor", CALCULATE(
        AVERAGE('Routes_Data'[Load_Factor])
    ),
    "Load_Factor_SelPeriod", CALCULATE(
        AVERAGE('Routes_Data'[Load_Factor]),
        __DS0FilterTable7,
        __DS0FilterTableSelPeriod
    ),
    "Load_Factor_Diff", [Load_Factor] - [Load_Factor_SelPeriod],
    "Node_Path", 
        IF(
            ISBLANK('Routes_Data'[Segment_Level_2]),
            'Routes_Data'[Segment_Level_1],
            IF(
                ISBLANK('Routes_Data'[Segment_Level_3]),
                'Routes_Data'[Segment_Level_1] & "/" & 'Routes_Data'[Segment_Level_2],
                'Routes_Data'[Segment_Level_1] & "/" & 'Routes_Data'[Segment_Level_2] & "/" & 'Routes_Data'[Segment_Level_3]
            )
        )
) 