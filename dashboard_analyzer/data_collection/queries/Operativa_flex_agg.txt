// DAX Query - Flexible Aggregation Operative Data
DEFINE

MEASURE 'Measure'[Load_Factor_CATIA] =
var lf_economy= divide(sum(Operation_data[pax_economy]),sum(Operation_data[capacity_economy]))
var lf_business=divide(sum(Operation_data[pax_business]),sum(Operation_data[capacity_business]))
var lf_premium_ec=divide(sum(Operation_data[pax_premium_ec]),sum(Operation_data[capacity_premium_ec]))
var lf_economy_and_premium_ec= divide(calculate(SUMx(Operation_data,Operation_data[pax_economy]+Operation_data[pax_premium_ec])),calculate(sumx(Operation_data, Operation_data[capacity_economy] +Operation_data[capacity_premium_ec])))
VAR lF_OVERALL = DIVIDE(calculate(sumx(Operation_data, Operation_data[pax_business]+ Operation_data[pax_economy] +Operation_data[pax_premium_ec])),CALCULATE(SUMx(Operation_data,Operation_data[capacity_business]+Operation_data[capacity_economy]+Operation_data[capacity_premium_ec])))
RETURN
SWITCH(true(),
    COUNTROWS(Cabin_Master)>1, lF_OVERALL,
    SELECTEDVALUE(Cabin_Master[Cabin_Show])="Economy",lf_economy,
    SELECTEDVALUE(Cabin_Master[Cabin_Show])="Business",lf_business,
    SELECTEDVALUE(Cabin_Master[Cabin_Show])="Premium EC",lf_premium_ec)*100
   
MEASURE 'Measure'[Misconex_CATIA] =
divide(sum(customer_connections[total_pax_misc]),sum(customer_connections[total_pax_conex]))*100
 
MEASURE 'Measure'[Mishandling_CATIA] =
var _bags = sum(f_mishandling[bags])
var _pax = sum(f_checkin[num_pax_flown])
return if(_pax > 0, divide(_bags, _pax) * 1000, 0)

    VAR __DS0FilterTable =
        TREATAS({"Business", "Economy", "Premium EC"}, 'Cabin_Master'[Cabin_Show])

    VAR __DS0FilterTable2 =
        TREATAS({"IB","YW"}, 'Company_Master'[Company])

    VAR __DS0FilterTable3 =
        TREATAS({"SH","LH"}, 'Haul_Master'[Haul_Aggr])

    VAR __DS0FilterTable5 =
        FILTER(
            KEEPFILTERS(VALUES('Date_Master'[Date])),
            'Date_Master'[Date] >= DATE(2024,01,01) && 'Date_Master'[Date] <= TODAY()
        )
    
    VAR _table = ADDCOLUMNS(
        Date_Master, 
        "Period_Group", 
        INT(DATEDIFF('Date_Master'[Date], MAX('Date_Master'[Date]), DAY) / {AGGREGATION_DAYS}) + 1
    )

    VAR __DS0Core = 
        CALCULATETABLE(
            SUMMARIZE(
                _table,
                [Period_Group],
                "Load_Factor", 'Measure'[Load_Factor_CATIA],
                "OTP15_adjusted", 'Measure'[OTP15_adjusted],
                "Mishandling", 'Measure'[Mishandling_CATIA],
                "Misconex", 'Measure'[Misconex_CATIA],
                "Min_Date", MIN('Date_Master'[Date]),
                "Max_Date", MAX('Date_Master'[Date])
            ),
            __DS0FilterTable,
            __DS0FilterTable2,
            __DS0FilterTable3,
            __DS0FilterTable5
        )

EVALUATE
    __DS0Core
ORDER BY [Period_Group] DESC 